# 기술 문서: 하이브리드 증강 시스템 및 버그 수정

## 1. 개요

본 문서는 2025년 12월 22일에 진행된 대규모 코드 리팩토링 및 버그 수정 사항을 기술합니다. 주요 변경점은 기존 무기 시스템을 유연하고 확장 가능하게 개선한 **하이브리드 증강 시스템(Hybrid Augment System)**의 도입과, Unity 실행 순서 문제로 발생했던 **`NullReferenceException` 오류 수정**입니다.

새로운 증강 시스템은 무기의 스탯을 영구적으로 변경하는 **패시브 효과**와 공격 시마다 특정 로직을 발동시키는 **액티브 효과**를 모두 지원하는 것을 목표로 설계되었습니다.

## 2. 하이브리드 증강 시스템

### 2.1. 핵심 컴포넌트

새로운 시스템은 아래와 같은 핵심 스크립트들로 구성됩니다.

#### `WeaponStats.cs`
*   **역할:** 모든 무기 관련 스탯(공격력, 공격 딜레이, 투사체 수, 공격 범위 등)을 담는 중앙 데이터 컨테이너 클래스입니다.
*   **목적:** 기존에 각 무기 클래스(`ProjectileWeapon`, `AoEWeapon` 등)에 흩어져 있던 스탯 변수들을 하나로 통합하여 관리를 용이하게 합니다.

#### `IAugment.cs` (확장)
*   **역할:** 모든 증강이 구현해야 하는 인터페이스입니다.
*   **주요 메서드:**
    *   `void ModifyStats(WeaponStats stats)`: 무기의 최종 스탯(`finalStats`)을 변경하는 메서드입니다. "+10 데미지", "+1 투사체"와 같은 패시브 효과 구현에 사용됩니다.
    *   `void OnAttack(Weapon weapon)`: 무기가 공격할 때마다 호출되는 메서드입니다. "공격 시 10% 확률로 체인 라이트닝 발동"과 같은 액티브(트리거) 효과 구현에 사용됩니다.

#### `Weapon.cs` (리팩토링)
*   **역할:** 모든 무기 클래스의 부모 클래스로, 증강 시스템의 핵심 로직을 담당합니다.
*   **주요 필드 및 프로퍼티:**
    *   `baseStats (WeaponStats)`: Inspector에서 설정하는 무기의 순수 기본 스탯입니다.
    *   `finalStats (WeaponStats)`: `baseStats`에 모든 증강 효과가 적용된 후의 최종 스탯입니다. 실제 공격 로직은 이 `finalStats`를 사용합니다.
*   **주요 메서드:**
    *   `AddAugment(IAugment augment)`: 무기에 증강을 추가하고 `RecalculateStats()`를 호출합니다.
    *   `RecalculateStats()`: `finalStats`를 `baseStats`로 초기화한 뒤, 가지고 있는 모든 증강의 `ModifyStats()`를 순차적으로 호출하여 최종 스탯을 다시 계산합니다.

### 2.2. 데이터 흐름

증강이 적용되고 최종 스탯이 계산되는 과정은 아래와 같습니다.

```mermaid
graph TD
    subgraph "1. 스탯 계산 (RecalculateStats)"
        A[baseStats] -->|복사| B(finalStats)
        C{Augment 1} -->|ModifyStats()| B
        D{Augment 2} -->|ModifyStats()| B
        E[...] --> B
    end
    
    subgraph "2. 공격 실행 (AttackLogic)"
        B --> F[공격 로직 실행<br/>(데미지, 투사체 수 등 참조)]
        C -->|OnAttack()| F
        D -->|OnAttack()| F
        E --> F
    end

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#bbf,stroke:#333,stroke-width:2px
```
1.  **스탯 계산:** `RecalculateStats`가 호출되면, `finalStats`는 먼저 `baseStats`의 값으로 초기화됩니다. 그 후, 무기에 장착된 모든 증강(`Augment`)들이 순서대로 `finalStats`의 값을 변경하여 최종 스탯을 완성합니다.
2.  **공격 실행:** 무기의 `AttackLogic`이 실행될 때, 공격력, 투사체 수 등 모든 수치는 `finalStats`에서 가져와 사용합니다. 동시에, 모든 증강의 `OnAttack` 메서드가 호출되어 추가 효과를 발동시킬 기회를 가집니다.

### 2.3. 사용 방법

1.  **증강 생성:** `Assets > Create > Augments` 메뉴에서 원하는 증강 타입(`Damage Up Augment` 등)을 선택하여 ScriptableObject 에셋을 생성합니다.
2.  **증강 적용:** 게임 로직 내에서 `Weapon` 컴포넌트의 `AddAugment(증강에셋)` 메서드를 호출하여 무기에 증강을 장착합니다.

---

## 3. `NullReferenceException` 버그 수정

### 3.1. 문제 현상
게임 시작 시 `AutoAttack.cs`의 코루틴에서 `weapon.finalStats`가 `null`이어서 `NullReferenceException` 오류가 발생했습니다.

### 3.2. 원인 분석
이 문제는 **Unity의 스크립트 실행 순서(Execution Order)** 때문에 발생했습니다.
1.  `PlayerController`의 `Awake()`에서 `autoAttacker.GameStart()`를 호출합니다.
2.  이 시점은 `Weapon` 컴포넌트의 `Awake()`가 실행되었다는 보장이 없는 시점입니다.
3.  `Weapon`의 `Awake()`에서 `finalStats`가 초기화되는데, 이 과정이 끝나기 전에 `AutoAttack`의 코루틴이 `finalStats`에 접근하여 `null` 참조 오류가 발생한 것입니다.

### 3.3. 해결 방법
모든 컴포넌트의 `Awake()`가 실행된 후에 호출되는 것이 보장되는 `Start()` 메서드로 초기화 로직을 이동하여 문제를 해결했습니다.

*   **수정 파일:** `PlayerController.cs`
*   **수정 내용:** `autoAttacker.GameStart()` 호출을 `Awake()` 메서드에서 `Start()` 메서드로 옮겼습니다.

이 수정을 통해 모든 `Weapon`이 안전하게 초기화된 후 공격 로직이 시작되도록 보장합니다.
